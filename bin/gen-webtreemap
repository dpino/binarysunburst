#!/usr/bin/perl

use strict;

my $template = "./bin/.template-webtreemap";
my $nm = "nm.out"; 
my $output_dir = "output";
my $title = "WebTreeMap";

while (@ARGV) {
    my $arg = shift;
    if ($arg =~ /--nm-output/) {
        $nm = shift;
    }
    if ($arg =~ /--output-dir/) {
        $output_dir = shift;
    }
    if ($arg =~ /--title/) {
        $title = shift;
    }
    if ($arg =~ /--help/) {
        help();
    }
}

if (! -f $nm) {
   error("Couldn't find $nm\n");
   help();
}

`cp -Rf $template $output_dir`;
print "Generating '$title' from '$nm' into '$output_dir' folder...\n";
`./bin/bloat --define-ktree-var --nm-output=$nm syms > $output_dir/html/data.json`;

my $index = "$output_dir/html/index.html";
my $content = readfile($index);
$content =~ s/###TITLE###/$title/g;
writefile($content, $index);

###

sub errorAndExit
{
    my($str) = @_;
    error($str);
    exit();
}

sub error
{
    my($str) = @_;
    print "$str\n";
}

sub help
{
    print "gen-treemap\n";
    print "\t--nm-output=<path>\tPath to file generated with \"nm -C -S -l\"\n";
    print "\t--output-dir=<path>\tPath to folder where to place results (html + data)\n";
    print "\t--title=\"<TEXT>\"\tTitle of the chart\n";
    exit();
}

sub readfile
{
    my($filename) = @_;

    my $content = do {
        local $/ = undef;
        open FILE, "<$filename";
        <FILE>
    };
    return $content;
}

sub writefile
{
    my($content, $filename) = @_;

    open FILE, ">$filename";
    print FILE $content;
    close FILE;
}
